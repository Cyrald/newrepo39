# –ü–ª–∞–Ω –≤–Ω–µ—Å–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ Routes –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

**–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞:** ‚úÖ –¢–ó –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º  
**–î–∞—Ç–∞:** 29 –Ω–æ—è–±—Ä—è 2025

---

## üìã –ö–†–ê–¢–ö–ê–Ø –í–ï–†–°–ò–Ø (Checklist –¥–ª—è –≤—ã–±–æ—Ä–∞)

### üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1) - –ë–ª–æ–∫–∏—Ä—É—é—Ç production
- [ ] **1.1** –ò—Å–ø—Ä–∞–≤–∏—Ç—å LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts
- [ ] **1.2** –ò—Å–ø—Ä–∞–≤–∏—Ç—å Promocode Race Condition  
- [ ] **1.3** –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL Injection –≤ WebSocket

### üü° –í–´–°–û–ö–ò–ï (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2) - –ù–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è production
- [ ] **2.1** –î–æ–±–∞–≤–∏—Ç—å Zod –≤–∞–ª–∏–¥–∞—Ü–∏—é (addresses, payment-cards)
- [ ] **2.2** –°–æ–∑–¥–∞—Ç—å middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
- [ ] **2.3** –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫
- [ ] **2.4** –î–æ–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª admin.routes.ts

### üü¢ –°–†–ï–î–ù–ò–ï (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3) - –£–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞
- [ ] **3.1** –í—ã–Ω–µ—Å—Ç–∏ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
- [ ] **3.2** –î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
- [ ] **3.3** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Swagger/OpenAPI

### üîµ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4) - –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- [ ] **4.1** –í–Ω–µ–¥—Ä–∏—Ç—å Service Layer
- [ ] **4.2** –í–Ω–µ–¥—Ä–∏—Ç—å Repository Pattern
- [ ] **4.3** –î–æ–±–∞–≤–∏—Ç—å Unit/Integration —Ç–µ—Å—Ç—ã
- [ ] **4.4** –†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

---

## üìä –ê–ù–ê–õ–ò–ó –ö–û–†–†–ï–ö–¢–ù–û–°–¢–ò –¢–ó

### ‚úÖ –°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã –¢–ó:
1. **–î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑** - –∫–∞–∂–¥–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –æ–ø–∏—Å–∞–Ω–∞ —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∫–æ–¥–∞
2. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** - –ø—Ä–æ–±–ª–µ–º—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ –∫—Ä–∏—Ç–∏—á–Ω–æ—Å—Ç–∏
3. **–ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è** - –¥–ª—è –∫–∞–∂–¥–æ–π –ø—Ä–æ–±–ª–µ–º—ã –µ—Å—Ç—å –≥–æ—Ç–æ–≤—ã–π –∫–æ–¥
4. **–û—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤** - —É–∫–∞–∑–∞–Ω—ã –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è –ø—Ä–æ–±–ª–µ–º
5. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞

### ‚ö†Ô∏è –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ –¢–ó:
1. **–û–±—ä—ë–º —Ä–∞–±–æ—Ç** - –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –∑–∞–¥–∞—á–∏ —Ç—Ä–µ–±—É—é—Ç –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞
2. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏** - –Ω–µ –≤—Å–µ–≥–¥–∞ —É–∫–∞–∑–∞–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –º–µ–∂–¥—É –∑–∞–¥–∞—á–∞–º–∏
3. **–ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î** - –¥–ª—è sessions table –Ω—É–∂–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è
4. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–µ—Ç –ø–ª–∞–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### üéØ –û–±—â–∏–π –≤—ã–≤–æ–¥:
**–¢–ó –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –º–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –¥–ª—è –≤–Ω–µ–¥—Ä–µ–Ω–∏—è.** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω—è—Ç—å –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º.

---

## üîß –î–ï–¢–ê–õ–¨–ù–´–ô –ü–õ–ê–ù –í–ù–ï–°–ï–ù–ò–Ø –ò–ó–ú–ï–ù–ï–ù–ò–ô

---

## üî¥ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 1.1 –ò—Å–ø—Ä–∞–≤–∏—Ç—å LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (–±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–ø—É—Å–∫)  
**–í—Ä–µ–º—è:** 1-2 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

**–§–∞–π–ª 1: `server/storage.ts`**
```diff
+ // –î–æ–±–∞–≤–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å IStorage
+ getSupportConversation(userId: string): Promise<SupportConversation | undefined>;
+ createSupportMessageAttachment(attachment: InsertSupportMessageAttachment): Promise<SupportMessageAttachment>;

+ // –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–ª–∞—Å—Å DatabaseStorage
+ async getSupportConversation(userId: string): Promise<SupportConversation | undefined> {
+   const [conversation] = await db
+     .select()
+     .from(supportConversations)
+     .where(eq(supportConversations.userId, userId))
+     .limit(1);
+   return conversation;
+ }
+ 
+ async createSupportMessageAttachment(
+   attachment: InsertSupportMessageAttachment
+ ): Promise<SupportMessageAttachment> {
+   const [newAttachment] = await db
+     .insert(supportMessageAttachments)
+     .values(attachment)
+     .returning();
+   return newAttachment;
+ }
```

**–§–∞–π–ª 2: `server/routes/support.routes.ts`**
```diff
  router.get("/closed-search", authenticateToken, requireRole("admin", "consultant"), async (req, res) => {
    const query = req.query.q as string;
    
-   const closedConversations = await storage.searchClosedConversations(query);
+   const closedConversations = await storage.searchClosedConversations({
+     email: query,
+   });
    
    res.json(closedConversations);
  });
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
npm run check  # TypeScript –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –æ—à–∏–±–æ–∫
```

---

### 1.2 –ò—Å–ø—Ä–∞–≤–∏—Ç—å Promocode Race Condition

**–°–µ—Ä—å—ë–∑–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ—Ç–µ—Ä–∏)  
**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

#### –ü—Ä–æ–±–ª–µ–º–∞:
–í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –í–ù–ï —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ ‚Üí –≤—Ä–µ–º–µ–Ω–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞.

#### –†–µ—à–µ–Ω–∏–µ:
–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –í–°–Æ –ª–æ–≥–∏–∫—É –ø—Ä–æ–º–æ–∫–æ–¥–∞ –í–ù–£–¢–†–¨ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å pessimistic locking.

**–§–∞–π–ª: `server/routes/orders.routes.ts`**

–ü–æ–ª–Ω—ã–π –∫–æ–¥ –∑–∞–º–µ–Ω—ã –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –¢–ó (—Å—Ç—Ä–æ–∫–∏ 183-429).

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
1. –£–±—Ä–∞—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –ø—Ä–æ–º–æ–∫–æ–¥–∞ –ø–µ—Ä–µ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–µ–π
2. –î–æ–±–∞–≤–∏—Ç—å `.for('update')` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞
3. –í—ã–ø–æ–ª–Ω—è—Ç—å –≤—Å—é –≤–∞–ª–∏–¥–∞—Ü–∏—é –í–ù–£–¢–†–ò —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
4. –û–±–Ω–æ–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

#### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
# –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å race condition
# –°–æ–∑–¥–∞—Ç—å concurrent –∑–∞–ø—Ä–æ—Å—ã —Å –æ–¥–Ω–∏–º –ø—Ä–æ–º–æ–∫–æ–¥–æ–º
```

---

### 1.3 –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL Injection –≤ WebSocket

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üî¥ –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –ü—Ä–æ–±–ª–µ–º–∞:
–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ raw SQL –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–π –≤ WebSocket.

#### –ò–∑–º–µ–Ω–µ–Ω–∏—è:

**–§–∞–π–ª 1: `shared/schema.ts`**
```diff
+ export const sessions = pgTable("session", {
+   sid: varchar("sid").primaryKey(),
+   sess: jsonb("sess").notNull(),
+   expire: timestamp("expire").notNull(),
+ });
```

**–§–∞–π–ª 2: `server/routes.ts`**
```diff
  async function validateSessionFromCookie(cookieHeader: string | undefined) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ cookie ...
    
    const sid = unsignedValue;
    
    if (!SESSION_ID_REGEX.test(sid)) {
      logger.warn('Invalid session ID format detected', { 
        sid: sid.substring(0, 10) + '...' 
      });
      return null;
    }
    
    try {
-     const result = await db.execute(sql`SELECT sess FROM session WHERE sid = ${sid}`);
-     if (!result.rows || result.rows.length === 0) return null;
-     const sessionData = result.rows[0].sess as any;
-     if (!sessionData?.userId) return null;
      
+     const [session] = await db
+       .select()
+       .from(sessions)
+       .where(eq(sessions.sid, sid))
+       .limit(1);
+     
+     if (!session || !session.sess?.userId) return null;
+     
      return {
-       userId: sessionData.userId,
-       userRoles: sessionData.userRoles || []
+       userId: session.sess.userId,
+       userRoles: session.sess.userRoles || []
      };
    } catch (error) {
      logger.error('Session validation error', { error });
      return null;
    }
  }
```

**–§–∞–π–ª 3: `server/db.ts`**
```diff
+ import { sessions } from '@shared/schema';
  // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
# WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ SQL –æ—à–∏–±–æ–∫
```

---

## üü° –ü–†–ò–û–†–ò–¢–ï–¢ 2: –í–´–°–û–ö–ò–ï –ü–†–û–ë–õ–ï–ú–´

### 2.1 –î–æ–±–∞–≤–∏—Ç—å Zod –≤–∞–ª–∏–¥–∞—Ü–∏—é

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `shared/schema.ts` - –¥–æ–±–∞–≤–∏—Ç—å Zod —Å—Ö–µ–º—ã
- `server/routes/addresses.routes.ts` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é
- `server/routes/payment-cards.routes.ts` - –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤–∞–ª–∏–¥–∞—Ü–∏—é

#### –°—Ö–µ–º—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:

**`shared/schema.ts`:**
```typescript
export const createAddressSchema = z.object({
  label: z.string()
    .min(1, "–ù–∞–∑–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(100, "–ù–∞–∑–≤–∞–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Åa-zA-Z0-9\s]+$/, "–¢–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø—Ä–æ–±–µ–ª—ã"),
  
  fullAddress: z.string()
    .min(10, "–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π")
    .max(500, "–ê–¥—Ä–µ—Å —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  city: z.string()
    .min(2, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(100, "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ")
    .regex(/^[–∞-—è–ê-–Ø—ë–Å\s-]+$/, "–¢–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–µ –±—É–∫–≤—ã"),
  
  street: z.string()
    .min(2, "–ù–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ")
    .max(200, "–ù–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ"),
  
  building: z.string()
    .min(1, "–ù–æ–º–µ—Ä –¥–æ–º–∞ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(20, "–ù–æ–º–µ—Ä –¥–æ–º–∞ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  apartment: z.string()
    .max(20, "–ù–æ–º–µ—Ä –∫–≤–∞—Ä—Ç–∏—Ä—ã —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π")
    .optional(),
  
  postalCode: z.string()
    .regex(/^\d{6}$/, "–ò–Ω–¥–µ–∫—Å –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ 6 —Ü–∏—Ñ—Ä"),
  
  isDefault: z.boolean().optional().default(false),
});

export const updateAddressSchema = createAddressSchema.partial();

export const createPaymentCardSchema = z.object({
  yukassaPaymentToken: z.string()
    .min(1, "–¢–æ–∫–µ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω")
    .max(500, "–¢–æ–∫–µ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π"),
  
  cardLastFour: z.string()
    .regex(/^\d{4}$/, "–ü–æ—Å–ª–µ–¥–Ω–∏–µ 4 —Ü–∏—Ñ—Ä—ã –∫–∞—Ä—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏"),
  
  cardType: z.enum(["visa", "mastercard", "mir", "other"], {
    errorMap: () => ({ message: "–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø –∫–∞—Ä—Ç—ã" })
  }),
  
  isDefault: z.boolean().optional().default(false),
});

export const updatePaymentCardSchema = createPaymentCardSchema.partial();
```

#### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ routes:

–°–º. –¥–µ—Ç–∞–ª—å–Ω—ã–π –∫–æ–¥ –≤ –¢–ó (—Å—Ç—Ä–æ–∫–∏ 586-620).

---

### 2.2 –°–æ–∑–¥–∞—Ç—å middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `server/middleware/resourceOwnership.ts`

```typescript
import { Request, Response, NextFunction } from 'express';
import { logger } from '../utils/logger';

interface ResourceWithOwner {
  userId: string;
}

export function requireOwnership(
  resourceGetter: (id: string) => Promise<ResourceWithOwner | undefined>,
  resourceName: string
) {
  return async (req: Request, res: Response, next: NextFunction) => {
    try {
      const resource = await resourceGetter(req.params.id);
      
      if (!resource) {
        return res.status(404).json({ 
          message: `${resourceName} –Ω–µ –Ω–∞–π–¥–µ–Ω` 
        });
      }
      
      if (resource.userId !== req.userId) {
        logger.warn('IDOR attempt detected', {
          userId: req.userId,
          resourceId: req.params.id,
          resourceType: resourceName,
        });
        
        return res.status(404).json({ 
          message: `${resourceName} –Ω–µ –Ω–∞–π–¥–µ–Ω` 
        });
      }
      
      next();
    } catch (error) {
      next(error);
    }
  };
}
```

#### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ routes:

```typescript
// server/routes/addresses.routes.ts
import { requireOwnership } from '../middleware/resourceOwnership';

router.put(
  "/:id",
  authenticateToken,
  requireOwnership(
    (id) => storage.getUserAddress(id),
    "–ê–¥—Ä–µ—Å"
  ),
  async (req, res) => {
    // ... handler code
  }
);
```

---

### 2.3 –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø  
**–í—Ä–µ–º—è:** 3-4 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `server/utils/errors.ts`

```typescript
export class AppError extends Error {
  constructor(
    public statusCode: number,
    public message: string,
    public isOperational = true
  ) {
    super(message);
    Object.setPrototypeOf(this, AppError.prototype);
  }
}

export class ValidationError extends AppError {
  constructor(message: string) {
    super(400, message);
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super(404, `${resource} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
  }
}

export class UnauthorizedError extends AppError {
  constructor(message = '–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è') {
    super(401, message);
  }
}

export class ForbiddenError extends AppError {
  constructor(message = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω') {
    super(403, message);
  }
}

export class ConflictError extends AppError {
  constructor(message: string) {
    super(409, message);
  }
}
```

#### –û–±–Ω–æ–≤–∏—Ç—å: `server/middleware/errorHandler.ts`

–ö–æ–¥ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω –≤ –¢–ó (—Å—Ç—Ä–æ–∫–∏ 940-984).

---

### 2.4 –î–æ–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª admin.routes.ts

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü° –í–´–°–û–ö–ê–Ø  
**–í—Ä–µ–º—è:** 6-8 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –î–æ–±–∞–≤–∏—Ç—å endpoints:

1. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:**
   - `PUT /api/admin/users/:id` - –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   
2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–æ–ª—è–º–∏:**
   - `POST /api/admin/users/:id/roles` - –Ω–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å
   - `DELETE /api/admin/users/:id/roles/:role` - —É–¥–∞–ª–∏—Ç—å —Ä–æ–ª—å
   
3. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞–º–∏:**
   - `GET /api/admin/promocodes` - —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤
   - `POST /api/admin/promocodes` - —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
   - `PUT /api/admin/promocodes/:id` - –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
   - `DELETE /api/admin/promocodes/:id` - —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–º–æ–∫–æ–¥
   
4. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:**
   - `GET /api/admin/stats/period` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –ø–µ—Ä–∏–æ–¥—É

–ü–æ–ª–Ω—ã–π –∫–æ–¥ –≤ –¢–ó (—Å—Ç—Ä–æ–∫–∏ 1013-1268).

---

## üü¢ –ü–†–ò–û–†–ò–¢–ï–¢ 3: –°–†–ï–î–ù–ò–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 3.1 –í—ã–Ω–µ—Å—Ç–∏ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü¢ –°–†–ï–î–ù–Ø–Ø  
**–í—Ä–µ–º—è:** 2-3 —á–∞—Å–∞  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

#### –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `server/config/business.ts`

```typescript
export const BUSINESS_CONFIG = {
  order: {
    defaultDeliveryCost: 300,
    freeDeliveryThreshold: 3000,
    maxBonusPercent: 70,
  },
  websocket: {
    connectionLimit: 10,
    connectionWindow: 60 * 1000,
    messageLimit: 60,
    messageWindow: 60 * 1000,
  },
  bonus: {
    initialBonus: 100,
    tierThresholds: {
      basic: { min: 0, cashbackPercent: 5 },
      silver: { min: 10000, cashbackPercent: 7 },
      gold: { min: 50000, cashbackPercent: 10 },
    },
  },
} as const;
```

#### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –∫–æ–¥–µ:

```typescript
// server/routes/orders.routes.ts
import { BUSINESS_CONFIG } from '../config/business';

const deliveryCost = subtotal >= BUSINESS_CONFIG.order.freeDeliveryThreshold
  ? 0
  : BUSINESS_CONFIG.order.defaultDeliveryCost;
```

---

### 3.2 –î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –ù–∏–∑–∫–∞—è

#### –ü—Ä–∏–º–µ—Ä:

```typescript
/**
 * –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞
 * 
 * @route POST /api/orders
 * @access Authenticated users
 * @description –°–æ–∑–¥–∞—ë—Ç –∑–∞–∫–∞–∑, —Å–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–æ–≤–∞—Ä—ã —Å–æ —Å–∫–ª–∞–¥–∞, –ø—Ä–∏–º–µ–Ω—è–µ—Ç –ø—Ä–æ–º–æ–∫–æ–¥—ã/–±–æ–Ω—É—Å—ã
 * 
 * @body {CreateOrderSchema} data - –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞
 * @returns {Order} –°–æ–∑–¥–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑
 * 
 * @throws {400} VALIDATION_ERROR - –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
 * @throws {400} INSUFFICIENT_STOCK - –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–æ–≤–∞—Ä–∞
 * @throws {400} PROMOCODE_EXPIRED - –ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—Ç—ë–∫
 * @throws {404} PRODUCT_NOT_FOUND - –¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
router.post("/", authenticateToken, orderLimiter, async (req, res, next) => {
  // ...
});
```

–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º endpoints –≤–æ –≤—Å–µ—Ö route —Ñ–∞–π–ª–∞—Ö.

---

### 3.3 –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Swagger/OpenAPI

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üü¢ –ù–ò–ó–ö–ê–Ø  
**–í—Ä–µ–º—è:** 6-8 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
npm install swagger-ui-express swagger-jsdoc
npm install -D @types/swagger-ui-express @types/swagger-jsdoc
```

#### –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª: `server/swagger.ts`

```typescript
import swaggerJsdoc from 'swagger-jsdoc';
import swaggerUi from 'swagger-ui-express';

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'EcoMarket API',
      version: '1.0.0',
      description: 'API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–ª—è EcoMarket',
    },
    servers: [
      {
        url: process.env.NODE_ENV === 'production' 
          ? 'https://your-domain.com'
          : 'http://localhost:5000',
      },
    ],
  },
  apis: ['./server/routes/*.ts'],
};

const specs = swaggerJsdoc(options);

export { specs, swaggerUi };
```

#### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ `server/index.ts`:

```typescript
import { specs, swaggerUi } from './swagger';

app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs));
```

---

## üîµ –ü–†–ò–û–†–ò–¢–ï–¢ 4: –ê–†–•–ò–¢–ï–ö–¢–£–†–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø

### 4.1 –í–Ω–µ–¥—Ä–∏—Ç—å Service Layer

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üîµ –ù–ò–ó–ö–ê–Ø (—É–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)  
**–í—Ä–µ–º—è:** 12-16 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

#### –¶–µ–ª—å:
–û—Ç–¥–µ–ª–∏—Ç—å –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É –æ—Ç HTTP handlers.

#### –°–æ–∑–¥–∞—Ç—å —Å–µ—Ä–≤–∏—Å—ã:
- `server/services/order.service.ts`
- `server/services/promocode.service.ts`
- `server/services/bonus.service.ts`
- `server/services/product.service.ts`

#### –ü—Ä–∏–º–µ—Ä:

```typescript
// server/services/order.service.ts
export class OrderService {
  async createOrder(userId: string, data: CreateOrderData): Promise<Order> {
    // –í—Å—è –ª–æ–≥–∏–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∏–∑ orders.routes.ts
  }
  
  async updateOrderStatus(orderId: string, status: string): Promise<Order> {
    // –õ–æ–≥–∏–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
  }
  
  async getUserOrders(userId: string): Promise<Order[]> {
    return storage.getOrdersByUser(userId);
  }
}
```

#### –ü—Ä–∏–º–µ–Ω–∏—Ç—å –≤ routes:

```typescript
// server/routes/orders.routes.ts
const orderService = new OrderService();

router.post("/", authenticateToken, orderLimiter, async (req, res, next) => {
  try {
    const data = createOrderSchema.parse(req.body);
    const order = await orderService.createOrder(req.userId!, data);
    res.json(order);
  } catch (error) {
    next(error);
  }
});
```

---

### 4.2 –í–Ω–µ–¥—Ä–∏—Ç—å Repository Pattern

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üîµ –ù–ò–ó–ö–ê–Ø (—É–ª—É—á—à–µ–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã)  
**–í—Ä–µ–º—è:** 16-20 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –û—á–µ–Ω—å –≤—ã—Å–æ–∫–∞—è

#### –¶–µ–ª—å:
–†–∞–∑–±–∏—Ç—å –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–π `storage.ts` (950+ —Å—Ç—Ä–æ–∫) –Ω–∞ –º–æ–¥—É–ª—å–Ω—ã–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.

#### –°–æ–∑–¥–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏:
- `server/repositories/base.repository.ts`
- `server/repositories/user.repository.ts`
- `server/repositories/product.repository.ts`
- `server/repositories/order.repository.ts`
- –ò —Ç.–¥.

#### –ü—Ä–∏–º–µ—Ä:

```typescript
// server/repositories/base.repository.ts
export abstract class BaseRepository<T, InsertT> {
  constructor(protected table: any) {}
  
  async findById(id: string): Promise<T | undefined> {
    const [result] = await db
      .select()
      .from(this.table)
      .where(eq(this.table.id, id))
      .limit(1);
    return result;
  }
  
  async findAll(options?: PaginationOptions): Promise<T[]> {
    return db.select().from(this.table);
  }
}

// server/repositories/order.repository.ts
export class OrderRepository extends BaseRepository<Order, InsertOrder> {
  constructor() {
    super(orders);
  }
  
  async findByUser(userId: string): Promise<Order[]> {
    return db
      .select()
      .from(this.table)
      .where(eq(this.table.userId, userId))
      .orderBy(desc(this.table.createdAt));
  }
}
```

---

### 4.3 –î–æ–±–∞–≤–∏—Ç—å Unit/Integration —Ç–µ—Å—Ç—ã

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üîµ –ù–ò–ó–ö–ê–Ø (–∫–∞—á–µ—Å—Ç–≤–æ)  
**–í—Ä–µ–º—è:** 20-30 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –í—ã—Å–æ–∫–∞—è

#### –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:

```bash
npm install -D vitest @testing-library/react @testing-library/jest-dom
npm install -D supertest @types/supertest
```

#### –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç—ã:

```typescript
// test/server/routes/orders.test.ts
describe('POST /api/orders', () => {
  it('should create order successfully', async () => {
    const response = await request(app)
      .post('/api/orders')
      .set('Cookie', sessionCookie)
      .send(orderData);
    
    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('orderNumber');
  });
  
  it('should prevent promocode double spend', async () => {
    // Test race condition fix
  });
  
  it('should validate order data', async () => {
    const response = await request(app)
      .post('/api/orders')
      .set('Cookie', sessionCookie)
      .send({ invalid: 'data' });
    
    expect(response.status).toBe(400);
  });
});
```

---

### 4.4 –†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Ñ–∞–π–ª–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

**–°–µ—Ä—å—ë–∂–Ω–æ—Å—Ç—å:** üîµ –ù–ò–ó–ö–ê–Ø (–æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)  
**–í—Ä–µ–º—è:** 4-6 —á–∞—Å–æ–≤  
**–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°—Ä–µ–¥–Ω—è—è

#### –¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
server/
‚îú‚îÄ‚îÄ routes/ (12 —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ routes.ts
‚îú‚îÄ‚îÄ routes.old.ts
‚îî‚îÄ‚îÄ storage.ts
```

#### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:
```
server/
‚îú‚îÄ‚îÄ routes/ (12 —Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts
‚îÇ   ‚îú‚îÄ‚îÄ rateLimiter.ts
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts
‚îÇ   ‚îú‚îÄ‚îÄ csrf.ts
‚îÇ   ‚îî‚îÄ‚îÄ resourceOwnership.ts
‚îú‚îÄ‚îÄ services/ (–Ω–æ–≤—ã–µ)
‚îÇ   ‚îú‚îÄ‚îÄ order.service.ts
‚îÇ   ‚îú‚îÄ‚îÄ promocode.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ bonus.service.ts
‚îú‚îÄ‚îÄ repositories/ (–Ω–æ–≤—ã–µ)
‚îÇ   ‚îú‚îÄ‚îÄ base.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ user.repository.ts
‚îÇ   ‚îú‚îÄ‚îÄ product.repository.ts
‚îÇ   ‚îî‚îÄ‚îÄ order.repository.ts
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ business.ts
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ errors.ts
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts
‚îÇ   ‚îî‚îÄ‚îÄ sanitize.ts
‚îú‚îÄ‚îÄ routes.ts (—Ç–æ–ª—å–∫–æ WebSocket)
‚îî‚îÄ‚îÄ index.ts
```

#### –î–µ–π—Å—Ç–≤–∏—è:
1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
2. –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å —Ñ–∞–π–ª—ã
3. –û–±–Ω–æ–≤–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã
4. –£–¥–∞–ª–∏—Ç—å `routes.old.ts` –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìù –ü–û–†–Ø–î–û–ö –í–´–ü–û–õ–ù–ï–ù–ò–Ø (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

### –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (1-2 –¥–Ω—è)
1. –ò—Å–ø—Ä–∞–≤–∏—Ç—å LSP –æ—à–∏–±–∫–∏ –≤ support.routes.ts ‚úÖ
2. –ò—Å–ø—Ä–∞–≤–∏—Ç—å Promocode Race Condition ‚úÖ
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å SQL Injection –≤ WebSocket ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ TypeScript –æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è.

---

### –§–∞–∑–∞ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (3-5 –¥–Ω–µ–π)
4. –î–æ–±–∞–≤–∏—Ç—å Zod –≤–∞–ª–∏–¥–∞—Ü–∏—é ‚úÖ
5. –°–æ–∑–¥–∞—Ç—å middleware –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–ª–∞–¥–µ–Ω–∏—è ‚úÖ
6. –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –í—Å–µ endpoints –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –¥–∞–Ω–Ω—ã–µ, IDOR –∑–∞—â–∏—â–µ–Ω—ã.

---

### –§–∞–∑–∞ 3: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (5-7 –¥–Ω–µ–π)
7. –î–æ–ø–æ–ª–Ω–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª admin.routes.ts ‚úÖ
8. –í—ã–Ω–µ—Å—Ç–∏ hardcoded –∑–Ω–∞—á–µ–Ω–∏—è ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞.

---

### –§–∞–∑–∞ 4: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (3-5 –¥–Ω–µ–π)
9. –î–æ–±–∞–≤–∏—Ç—å JSDoc –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ‚úÖ
10. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Swagger/OpenAPI ‚úÖ

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** API –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω.

---

### –§–∞–∑–∞ 5: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 2-4 –Ω–µ–¥–µ–ª–∏)
11. –í–Ω–µ–¥—Ä–∏—Ç—å Service Layer ‚è∏Ô∏è
12. –í–Ω–µ–¥—Ä–∏—Ç—å Repository Pattern ‚è∏Ô∏è
13. –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã ‚è∏Ô∏è
14. –†–µ–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É ‚è∏Ô∏è

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** –ö–æ–¥ –º–æ–¥—É–ª—å–Ω—ã–π, –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ >70%.

---

## üéØ –ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è production:
- ‚úÖ –§–∞–∑–∞ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- ‚úÖ –§–∞–∑–∞ 2: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
- ‚ö†Ô∏è –§–∞–∑–∞ 3: –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å (—á–∞—Å—Ç–∏—á–Ω–æ)

**–°—Ä–æ–∫:** 1-2 –Ω–µ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç—ã –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

### –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ production:
- ‚úÖ –§–∞–∑—ã 1-4 –ø–æ–ª–Ω–æ—Å—Ç—å—é
- ‚ö†Ô∏è –§–∞–∑–∞ 5 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**–°—Ä–æ–∫:** 1-1.5 –º–µ—Å—è—Ü–∞ —Ä–∞–±–æ—Ç—ã –æ–¥–Ω–æ–≥–æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

### –ü–æ—Å–ª–µ –§–∞–∑—ã 1:
- [ ] 0 TypeScript –æ—à–∏–±–æ–∫
- [ ] 0 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

### –ü–æ—Å–ª–µ –§–∞–∑—ã 2:
- [ ] –í—Å–µ endpoints –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [ ] IDOR –∑–∞—â–∏—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —Ä–µ—Å—É—Ä—Å–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –ü–æ—Å–ª–µ –§–∞–∑—ã 3:
- [ ] –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞
- [ ] –ù–µ—Ç hardcoded –∑–Ω–∞—á–µ–Ω–∏–π

### –ü–æ—Å–ª–µ –§–∞–∑—ã 4:
- [ ] 100% endpoints –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã
- [ ] Swagger UI –¥–æ—Å—Ç—É–ø–µ–Ω

### –ü–æ—Å–ª–µ –§–∞–∑—ã 5 (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
- [ ] Code coverage >70%
- [ ] –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- [ ] –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç

---

## ‚ö†Ô∏è –†–ò–°–ö–ò –ò –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏:
1. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î –¥–ª—è sessions** - —Ç—Ä–µ–±—É–µ—Ç –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç–∏
2. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤** - –Ω—É–∂–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å concurrent –∑–∞–ø—Ä–æ—Å–∞–º–∏
3. **–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π** - —Ä–∏—Å–∫ –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –î–µ–ª–∞—Ç—å backup –ë–î –ø–µ—Ä–µ–¥ –∫–∞–∂–¥–æ–π —Ñ–∞–∑–æ–π
2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
3. –†–∞–∑–≤—ë—Ä—Ç—ã–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—ç—Ç–∞–ø–Ω–æ
4. –ú–æ–Ω–∏—Ç–æ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –¥–µ–ø–ª–æ—è

---

## üìû –ü–û–î–î–ï–†–ñ–ö–ê

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–∏ –≤–Ω–µ–¥—Ä–µ–Ω–∏–∏:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏ –ë–î
3. –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–∫–∞—Ö
4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `git bisect` –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞

---

**–ö–æ–Ω–µ—Ü –ø–ª–∞–Ω–∞**
